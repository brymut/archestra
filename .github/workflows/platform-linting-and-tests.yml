name: Platform Linting and Tests

on:
  workflow_call:

jobs:
  platform-linting-and-tests:
    name: Platform Linting and Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./platform
    steps:
      - name: Checkout project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Setup environment
        uses: ./.github/actions/setup-env
        with:
          working-directory: ./platform

      - name: Setup environment variables
        run: cp .env.example .env

      - name: Type checking, linting, formatting checks
        run: pnpm check:ci

  platform-integration-tests:
    name: Platform Integration Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.11.1

      - name: Build Docker image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          context: ./platform
          file: ./platform/Dockerfile
          push: false
          load: true
          tags: archestra/platform:ci-test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Start platform with docker compose
        run: |
          docker compose -f .github/testing/docker-compose-platform.yml up -d
          echo "=== Containers started ==="
          docker compose -f .github/testing/docker-compose-platform.yml ps
          echo ""
          echo "=== Waiting for services to initialize (30s) ==="
          sleep 30
          echo ""
          echo "=== Container status after wait ==="
          docker compose -f .github/testing/docker-compose-platform.yml ps
          echo ""
          echo "=== Quick log check for each container ==="
          docker logs archestra-platform-test --tail 50
          echo ""
          docker logs archestra-platform-test-custom-api-base-url --tail 50
          echo ""
          docker logs archestra-platform-test-custom-database-url --tail 50
          echo ""
          echo "=== Network inspection ==="
          docker network inspect testing_default || echo "Network not found"
          echo ""
          echo "=== Port bindings ==="
          docker port archestra-platform-test || echo "Container not running"
          docker port archestra-platform-test-custom-api-base-url || echo "Container not running"
          docker port archestra-platform-test-custom-database-url || echo "Container not running"

      - name: Check backend health
        run: |
          ports="9000 9001 9002"

          for port in $ports; do
            echo ""
            echo "=== Testing backend on port $port ==="
            max_attempts=10
            attempt=0
            success=false

            while [ $attempt -lt $max_attempts ]; do
              echo "Attempt $((attempt + 1))/$max_attempts on port $port..."

              # Try curl with verbose output for debugging
              if curl -v -f http://localhost:$port/health 2>&1; then
                echo "✓ Backend health check passed on port $port"
                success=true
                break
              else
                echo "curl exit code: $?"
              fi

              attempt=$((attempt + 1))

              if [ $attempt -lt $max_attempts ]; then
                echo "Retrying in 5s..."
                sleep 5
              fi
            done

            if [ "$success" = false ]; then
              echo ""
              echo "✗ Backend health check failed after $max_attempts attempts on port $port"
              echo "=== Checking if port is listening ==="
              netstat -tuln | grep ":$port" || echo "Port $port not listening"
              echo "=== Checking container processes ==="
              case $port in
                9000) docker exec archestra-platform-test ps aux || echo "Container not accessible" ;;
                9001) docker exec archestra-platform-test-custom-api-base-url ps aux || echo "Container not accessible" ;;
                9002) docker exec archestra-platform-test-custom-database-url ps aux || echo "Container not accessible" ;;
              esac
              exit 1
            fi
          done

      - name: Check frontend health
        run: |
          ports="3000 3001 3002"

          for port in $ports; do
            echo ""
            echo "=== Testing frontend on port $port ==="
            max_attempts=10
            attempt=0
            success=false

            while [ $attempt -lt $max_attempts ]; do
              echo "Attempt $((attempt + 1))/$max_attempts on port $port..."

              if curl -v -f http://localhost:$port/ 2>&1; then
                echo "✓ Frontend health check passed on port $port"
                success=true
                break
              else
                echo "curl exit code: $?"
              fi

              attempt=$((attempt + 1))

              if [ $attempt -lt $max_attempts ]; then
                echo "Retrying in 5s..."
                sleep 5
              fi
            done

            if [ "$success" = false ]; then
              echo ""
              echo "✗ Frontend health check failed after $max_attempts attempts on port $port"
              echo "=== Checking if port is listening ==="
              netstat -tuln | grep ":$port" || echo "Port $port not listening"
              exit 1
            fi
          done

      - name: Show container logs on failure
        if: failure()
        run: |
          echo "=== Container Status ==="
          docker compose -f .github/testing/docker-compose-platform.yml ps
          echo ""
          echo "=== Platform Container (default - port 9000) Logs ==="
          docker logs archestra-platform-test || echo "Container not found"
          echo ""
          echo "=== Platform Container (custom API URL - port 9001) Logs ==="
          docker logs archestra-platform-test-custom-api-base-url || echo "Container not found"
          echo ""
          echo "=== Platform Container (custom DB - port 9002) Logs ==="
          docker logs archestra-platform-test-custom-database-url || echo "Container not found"
          echo ""
          echo "=== PostgreSQL Container Logs ==="
          docker logs archestra-platform-test-postgresql || echo "Container not found"
          echo ""
          echo "=== All Container Stats ==="
          docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}\t{{.NetIO}}\t{{.BlockIO}}"
          echo ""
          echo "=== Port bindings check ==="
          docker port archestra-platform-test || echo "Container not running"
          docker port archestra-platform-test-custom-api-base-url || echo "Container not running"
          docker port archestra-platform-test-custom-database-url || echo "Container not running"
          echo ""
          echo "=== Network connectivity from host ==="
          for port in 9000 9001 9002 3000 3001 3002; do
            echo "Testing port $port..."
            nc -zv localhost $port 2>&1 || echo "Port $port not accessible"
          done

      - name: Cleanup
        if: always()
        run: |
          docker compose -f .github/testing/docker-compose-platform.yml down -v

  build-platform-docker-image:
    name: Build platform Docker image
    uses: ./.github/workflows/build-dockerhub-image.yml
    permissions:
      contents: read
      id-token: write
    with:
      image_directory: ./platform
      image_name: platform
      version: ${{ github.sha }}
      push_image: false

  helm-chart-linting-and-tests:
    name: Helm Chart Linting and Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./platform/helm
    steps:
      - name: Checkout project
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Linting
        run: helm lint .

      - name: Tests
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest.git
          helm unittest .

      - name: helm package
        # NOTE: can't use ${{ github.sha }} for version here because it's not a valid version number
        # and helm package explicitly checks this
        run: |
          helm package . --version v0.0.1 --app-version v0.0.1
